@page "/dashboard"
@using RenaultSmartCenter.Application.Features.Dashboard
@using RenaultSmartCenter.BlazorUI.Services
@using Microsoft.AspNetCore.Authorization
@inject ApiClient ApiClient
@inject AuthenticationStateProvider AuthStateProvider
@inject RenaultSmartCenter.BlazorUI.Services.ILocalStorageService LocalStorage
@attribute [Authorize]

<PageTitle>Dashboard - Renault Smart Center</PageTitle>

@if (dashboard == null)
{
    <div>Loading...</div>
}
else
{
    <div class="dashboard">
        <h2>Dashboard</h2>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üöó</div>
                <div class="stat-content">
                    <div class="stat-value">@dashboard.CarsInService</div>
                    <div class="stat-label">Cars in Service</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üìÖ</div>
                <div class="stat-content">
                    <div class="stat-value">@dashboard.TodaysAppointments</div>
                    <div class="stat-label">Today's Appointments</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-content">
                    <div class="stat-value">@dashboard.CompletedJobsToday</div>
                    <div class="stat-label">Completed Today</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-content">
                    <div class="stat-value">$@dashboard.DailyRevenue.ToString("N2")</div>
                    <div class="stat-label">Daily Revenue</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-content">
                    <div class="stat-value">$@dashboard.MonthlyRevenue.ToString("N2")</div>
                    <div class="stat-label">Monthly Revenue</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">‚ö†Ô∏è</div>
                <div class="stat-content">
                    <div class="stat-value">@dashboard.DelayedVehicles</div>
                    <div class="stat-label">Delayed Vehicles</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üì¶</div>
                <div class="stat-content">
                    <div class="stat-value">@dashboard.LowStockParts</div>
                    <div class="stat-label">Low Stock Parts</div>
                </div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <h3>Revenue Trend (Last 7 Days)</h3>
                <div class="chart-placeholder">
                    Chart visualization would go here
                </div>
            </div>

            <div class="chart-card">
                <h3>Service Type Distribution</h3>
                <div class="chart-placeholder">
                    Chart visualization would go here
                </div>
            </div>
        </div>
    </div>
}

<style>
    .dashboard {
        padding: 1rem;
    }

    .dashboard h2 {
        color: #FFD700;
        margin-bottom: 1.5rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: #2d2d2d;
        border-radius: 8px;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        border: 1px solid #444;
    }

    .stat-icon {
        font-size: 2.5rem;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #FFD700;
    }

    .stat-label {
        color: #ccc;
        font-size: 0.9rem;
    }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 1rem;
    }

    .chart-card {
        background: #2d2d2d;
        border-radius: 8px;
        padding: 1.5rem;
        border: 1px solid #444;
    }

    .chart-card h3 {
        color: #FFD700;
        margin-bottom: 1rem;
    }

    .chart-placeholder {
        height: 200px;
        background: #1a1a1a;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
    }
</style>

@code {
    private DashboardDto? dashboard;
    private Guid branchId = Guid.Parse("11111111-1111-1111-1111-111111111111"); // Default branch

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var token = await GetAuthToken();
            if (!string.IsNullOrEmpty(token))
            {
                ApiClient.SetToken(token);
                dashboard = await ApiClient.GetAsync<DashboardDto>($"/api/dashboard/{branchId}");
            }
        }
        catch (Exception ex)
        {
            // Handle error
        }
    }

    private async Task<string?> GetAuthToken()
    {
        // This would typically come from local storage
        return await LocalStorage.GetItemAsync<string>("authToken");
    }
}
